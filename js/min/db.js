(function(){function K(a,d){var b=arguments.length,c=1==b?a:d,e,g={};h.isArr(c)?(b=c.length,e=function(a){for(var e=0;e<b;e++)if(-1<p(a,c[e]))return!0;return!1}):e=function(a){return-1<p(a,c)};return 2==b?(g={},g[a]=e,g):e}function s(){var a=l.call(arguments),d,b,c,e,g,j,i,f;b=h.isArr(this)?this:a.shift();f=b.length?l.call(b):t(b);2==a.length&&h.isStr(a[0])&&(c={},c[a[0]]=a[1],a=[n({},c)]);for(b=0;b<a.length;b++)if(d=a[b],h.isFun(d)){d=d.single||d;g=f.length;for(i=g-1;0<=i;i--)c=f[i],d(c)&&(g-(i+
1)&&(j=i+1,f.splice(j,g-j)),g=i);j=i+1;g-j&&f.splice(j,g-j)}else k(d,function(a,b){if(h.isFun(b)){g=f.length;for(i=g-1;i>=0;i--){c=f[i];if(a in c){e=c[a];h.isFun(e)&&(e=e());if(b(e,c)){if(g-(i+1)){j=i+1;f.splice(j,g-j)}g=i}}}}else{g=f.length;for(i=g-1;i>=0;i--){c=f[i];e=c[a];h.isFun(e)&&(e=e());if(a in c&&e===b){if(g-(i+1)){j=i+1;f.splice(j,g-j)}g=i}}}j=i+1;g-j&&f.splice(j,g-j)});f.first=f[0];f.last=f[f.length-1];return f}function z(a){var d={};k(a,function(a){d[a]=!0});return function(a){for(var c in d)if(c in
a)return!1;return!0}}function A(a,d){var b,c=arguments.length,e,g={};1==c?e=a:2==c&&(e=d);e=e.toString().toLowerCase();b=function(a){return-1<a.toString().toLowerCase().search(e)};return 2==c?(g={},g[a]=b,g):b}function B(a){var d={x:a};return function(a,c){2==arguments.length&&(d[a]=c);return d[a]}}function t(a){var d=[],b;for(b in a)d.push(a[b]);return d}function L(a,d){var b,c=this;d!==C&&(b=a,a={},a[b]=d);h.isFun(a)?k(c,a):k(a,function(a,b){h.isFun(b)?k(c,function(c){if(h.isFun(c[a]))c[a](b(c));
else c[a]=b(c)}):k(c,function(c){if(h.isFun(c[a]))c[a](b);else c[a]=b})});return this}function n(a,d){for(var b,c,e,g,j=arguments.length,i=0;i<j;i++){b=arguments[i];for(var f in b)c=a[f],e=b[f],a!==e&&(e&&(e.constructor==Object||(g=h.isArr(e)))?(g?(g=!1,c=c&&h.isArr(constructor)?c:[]):c=c&&c.constructor==Object?c:{},a[f]=n(c,e)):e!==C&&(a[f]=e))}return a}function u(a,d){var b=[],c;2==arguments.length?(c=a,a=d):c=this;if(h.isArr(c))b=D(c,a);else{var b={},e;for(e in c)h.isFun(c[e])||(b[e]=a.call(this,
c[e]))}return b}function E(a){q++;for(var d=0,b=a.length;d<b;d++)a[d].constructor("i",q)}var C,l=Array.prototype.slice,v=Object.prototype.toString,F={},G={},q=0,h={isFun:function(a){return!(!a||!a.constructor||!a.call||!a.apply)},isStr:function(a){return!!(""===a||a&&a.charCodeAt&&a.substr)},isNum:function(a){return"[object Number]"===v.call(a)},isArr:[].isArray||function(a){return"[object Array]"===v.call(a)},isObj:function(a){return null==a?"object"==String(a):"[object Object]"===v.call(a)||!0}},
p=[].indexOf?function(a,d){return a.indexOf(d)}:function(a,d){for(var b=a.length-1;-1!=b&&d!=a[b];b--);return b},D=[].map?function(a,d){return a.map(d)}:function(a,d){for(var b=[],c=0,e=a.length;c<e;c++)b.push(d(a[c],c));return b},k=[].forEach?function(a,d){if(h.isArr(a))a.forEach(d);else for(var b in a)d(b,a[b])}:function(a,d){if(h.isArr(a))for(var b=0,c=a.length;b<c;b++)d(a[b],b);else for(b in a)d(b,a[b])};k("< <= > >= == === != !==".split(" "),function(a){G[a]=Function("rhs","return function(x){return x"+
a+"rhs}")});var w,x={};w=function(a,d){var b,c=arguments.length,e=1==c?a:d||[],g={};if(!h.isArr(e))throw new TypeError("isin's argument is wrong. ",e);e.length?20>e.length&&h.isNum(e[0])?(b=e.join(","),b=x[b]?x[b]:x[b]=new Function("x","return x=="+e.join("||x=="))):b=function(a){return-1<p(e,a)}:b=h.isFun(e)?function(a){return-1<p(e(),a)}:e;return 2==c?(g={},g[a]=b,g):b};var H,M=/^\s*([=<>!]+)['"]*(.*)$/,y,o={};H=function(){return function(a,d){var b,c;if(h.isStr(a)){c=a;if(1==arguments.length)if(o[c])b=
o[c];else{try{b=new Function("x,rec","return x "+c)}catch(e){b={}}try{b.single=new Function("rec","return "+a)}catch(g){}o[c]=b}2==arguments.length&&h.isStr(d)&&(b={},c=d,o[c]||(o[c]=null!==(y=c.match(M))?G[y[1]](y[2].replace(/['"]$/,"")):new Function("x,rec","return x "+c)),b[a]=o[c]);return b}}};var I,J={};k("has hasKey insert invert missing isin group keyBy remove update where select find sort orderBy order each like".split(" "),function(a){J[a]=true});I=J;self.DB=function(a,d){function b(){j||
(j=!0,k(g,function(a){a.call(f,m)}),j=!1)}function c(a){for(var b in I)a[b]=f[b];return a}var e={},g=[],j=!1,i=!1,f=H(),m=[];n(f,{constrain:function(){var a=n,b=e,c;c=arguments;var d={};2==c.length?(d[c[0]]=c[1],c=d):c=1==c.length?c[0]:void 0;a(b,c)},each:u,findFirst:function(){var a=f.find.apply(this,l.call(arguments));return a.length?a[0]:{}},has:K,hasKey:function(){return this.find(z(l.call(arguments))).invert()},isin:w,like:A,invert:function(a){var b=m,e=[];E(a||this);for(var a=0,d=b.length;a<
d;a++)b[a].constructor("i")!=q&&e.push(b[a]);return c(e)},map:u,missing:function(){var a=z(l.call(arguments));return h.isArr(this)?this.find(a):a},sync:function(a){a?g.push(a):b()},template:{create:function(a){i=a},update:function(a){n(i||{},a)},get:function(){return i},destroy:function(){i=!1}},update:function(){var a=L.apply(h.isArr(this)?this:f.find(),l.call(arguments));b();return c(a)}});f.not=function(){return f.apply(this,l(arguments))};f.group=function(a){var b={},e=h.isArr(this)?this:f.find();
k(e,function(e){a in e&&(b[e[a]]||(b[e[a]]=c([])),b[e[a]].push(e))});return b};f.keyBy=function(a){var b=f.group.apply(this,arguments);k(b,function(a,c){b[a]=c[0]});return b};f.order=f.sort=f.orderBy=function(a,b){var e,d=arguments.length,g,i=h.isArr(this)?this:f.find();h.isFun(a)?e=a:h.isStr(a)&&(1==d?g="x-y":2==d&&(g=h.isStr(b)?{asc:"x-y",desc:"y-x"}[b.toLowerCase()]:b),h.isStr(g)&&!F[g]&&(F[g]=new Function("x,y","return "+g)),eval("fnSort=function(a,b){return order(a."+a+", b."+a+")}"));return c(l.call(i).sort(e))};
f.where=f.find=function(){var a=l.call(arguments||[]);h.isArr(this)||(a=[m].concat(a));return c(s.apply(this,a))};f.view=function(a){var c={};f.sync(function(b){var e={},d;k(b,function(b){a in b&&(e[b[a]]=b)});for(d in e)d in c?c[d]!==e[d]&&(c[d]=e[d]):c[d]=e[d];for(d in c)d in e||delete c[d]});b();return c};f.select=function(a){var b=h.isArr(this)?this:f.find(),e,d={};1<arguments.length?a=l.call(arguments):h.isStr(a)&&(a=[a]);e=a.length;k(a,function(a,c){if("*"==a)d=D(b,t);else for(var f=0,g=b.length;f<
g;f++)row=b[f],a in row&&(1<e?(d[f]||(d[f]=[]),d[f][c]=row[a]):d[f]=row[a])});return c(t(d))};f.insert=function(a){var d={},f=[],g=[];1<arguments.length?f=l.call(arguments):h.isArr(a)?f=a:f.push(a);k(f,function(a){if(e.unique&&(d={},k(m,function(a,b){d[a[e.unique]]=b}),a[e.unique]in d)){g.push(d[a[e.unique]]);return}var b=m.length,c;if(i){var f={};k(i,function(a,b){f[a]=h.isFun(b)?b():b});a=n(f,a)}try{c=new (B(b)),n(c,a),m.push(c)}catch(j){a.constructor=B(b),m.push(a)}g.push(b)});b();for(var f=g,
j=[],r=0,o=f.length;r<o;r++)j[r]=m[f[r]];return c(j)};f.remove=function(a,d){var e,g,i=[];e=h.isArr(this)?this:h.isArr(a)?a:0<arguments.length?f.find.apply(this,l.call(arguments)):f.find();E(e);var j=m.length-1;for(e=m.length;0<=j;j--)m[j].constructor("i")==q?i.push(m[j]):(e-(j+1)&&(g=j+1,m.splice(g,e-g)),e=j);g=j+1;e-g&&m.splice(g,e-g);b();return c(i.reverse())};if(1==arguments.length)if(h.isArr(a))f.insert(a);else if(h.isFun(a))f.insert(a());else{if(h.isStr(a))return f.apply(this,arguments);h.isObj(a)&&
f.insert(a)}else 1<arguments.length&&f.insert(l.call(arguments));f.__raw__=m;return f};n(DB,{find:s,each:u,like:A,trace:function(a,d){a.__$$tracer$$__={};k(a,function(b,c){h.isFun(c)&&(a.__$$tracer$$__[b]=c,a[b]=function(){console.log.apply(this,[b+":"].concat(l.call(arguments)));d&&d.apply(this,arguments);return a.__$$tracer$$__[b].apply(this,arguments)})})},isin:w,objectify:function(a,d){var b=[];k(d,function(c){var e={};k(a,function(a,b){e[a]=c[b]});b.push(e)});return b},findFirst:function(){var a=
s.apply(this,l.call(arguments));return a.length?a[0]:{}},reduceLeft:function(a,d){var b=h.isStr(d)?new Function("y,x","return y "+d):d;return function(c){for(var e=a,d=0,h=c.length;d<h;d++)c[d]&&(e=b(e,c[d]));return e}},reduceRight:function(a,d){d=DB.reduceLeft(a,d);return function(a){return d(a.reverse())}}})})();
