(function(){function M(a,d){var b=arguments.length,c=1==b?a:d,e,f={};h.isArr(c)?(b=c.length,e=function(a){for(var e=0;e<b;e++)if(-1<r(a,c[e]))return!0;return!1}):e=function(a){return-1<r(a,c)};return 2==b?(f={},f[a]=e,f):e}function t(){var a=n.call(arguments),d,b,c,e,f,k,j,g;b=h.isArr(this)?this:a.shift();g=b.length?n.call(b):u(b);2==a.length&&h.isStr(a[0])&&(c={},c[a[0]]=a[1],a=[q({},c)]);for(b=0;b<a.length;b++)if(d=a[b],h.isFun(d)){d=d.single||d;f=g.length;for(j=f-1;0<=j;j--)c=g[j],d(c)&&(f-(j+
1)&&(k=j+1,g.splice(k,f-k)),f=j);k=j+1;f-k&&g.splice(k,f-k)}else l(d,function(a,b){if(h.isFun(b)){f=g.length;for(j=f-1;0<=j;j--)c=g[j],a in c&&(e=c[a],h.isFun(e)&&(e=e()),b(e,c)&&(f-(j+1)&&(k=j+1,g.splice(k,f-k)),f=j))}else{f=g.length;for(j=f-1;0<=j;j--)c=g[j],e=c[a],h.isFun(e)&&(e=e()),a in c&&e===b&&(f-(j+1)&&(k=j+1,g.splice(k,f-k)),f=j)}k=j+1;f-k&&g.splice(k,f-k)});g.first=g[0];g.last=g[g.length-1];return g}function A(a){var d={};l(a,function(a){d[a]=!0});return function(a){for(var c in d)if(c in
a)return!1;return!0}}function B(a,d){var b,c=arguments.length,e,f={};1==c?e=a:2==c&&(e=d);e=e.toString().toLowerCase();b=function(a){return-1<a.toString().toLowerCase().search(e)};return 2==c?(f={},f[a]=b,f):b}function C(a){var d={x:a};return function(a,c){2==arguments.length&&(d[a]=c);return d[a]}}function u(a){var d=[],b;for(b in a)d.push(a[b]);return d}function N(a,d){var b,c=this;d!==D&&(b=a,a={},a[b]=d);h.isFun(a)?l(c,a):l(a,function(a,b){h.isFun(b)?l(c,function(c){if(h.isFun(c[a]))c[a](b(c));
else c[a]=b(c)}):l(c,function(c){if(h.isFun(c[a]))c[a](b);else c[a]=b})});return this}function q(a,d){for(var b,c,e,f,k=arguments.length,j=0;j<k;j++){b=arguments[j];for(var g in b)c=a[g],e=b[g],a!==e&&(e&&(e.constructor==Object||(f=h.isArr(e)))?(f?(f=!1,c=c&&h.isArr(constructor)?c:[]):c=c&&c.constructor==Object?c:{},a[g]=q(c,e)):e!==D&&(a[g]=e))}return a}function v(a,d){var b=[],c;2==arguments.length?(c=a,a=d):c=this;if(h.isArr(c))b=E(c,a);else{var b={},e;for(e in c)h.isFun(c[e])||(b[e]=a.call(this,
c[e]))}return b}function F(a){s++;for(var d=0,b=a.length;d<b;d++)a[d].constructor("i",s)}var D,n=Array.prototype.slice,w=Object.prototype.toString,G={},H={},s=0,h={isFun:function(a){return!(!a||!a.constructor||!a.call||!a.apply)},isStr:function(a){return!!(""===a||a&&a.charCodeAt&&a.substr)},isNum:function(a){return"[object Number]"===w.call(a)},isArr:[].isArray||function(a){return"[object Array]"===w.call(a)},isObj:function(a){return null==a?"object"==String(a):"[object Object]"===w.call(a)||!0}},
r=[].indexOf?function(a,d){return a.indexOf(d)}:function(a,d){for(var b=a.length-1;-1!=b&&d!=a[b];b--);return b},O={}.keys||function(a){var d=[],b;for(b in a)d.push(b);return d},E=[].map?function(a,d){return a.map(d)}:function(a,d){for(var b=[],c=0,e=a.length;c<e;c++)b.push(d(a[c],c));return b},l=[].forEach?function(a,d){if(0!==a.length)if(h.isArr(a))a.forEach(d);else for(var b in a)d(b,a[b])}:function(a,d){if(0!==a.length)if(h.isArr(a))for(var b=0,c=a.length;b<c;b++)d(a[b],b);else for(b in a)d(b,
a[b])};l("< <= > >= == === != !==".split(" "),function(a){H[a]=Function("rhs","return function(x){return x"+a+"rhs}")});var x,y={};x=function(a,d){var b,c=arguments.length,e=1==c?a:d||[],f={};if(!h.isArr(e))throw new TypeError("isin's argument is wrong. ",e);e.length?20>e.length&&h.isNum(e[0])?(b=e.join(","),b=y[b]?y[b]:y[b]=new Function("x","return x=="+e.join("||x=="))):b=h.isStr(e)?new Function("x","return indexOf("+e+", x) > -1"):function(a){return-1<r(e,a)}:b=h.isFun(e)?function(a){return-1<
r(e(),a)}:e;return 2==c?(f={},f[a]=b,f):b};var I,P=/^\s*([=<>!]+)['"]*(.*)$/,z,p={};I=function(){return function(a,d){var b,c;if(h.isStr(a)){c=a;if(1==arguments.length)if(p[c])b=p[c];else{try{b=new Function("x,rec","try { return x "+c+"} catch(e) {return undefined;}")}catch(e){b={}}try{b.single=new Function("rec","try { return "+a+"} catch(e) {return undefined;}")}catch(f){}p[c]=b}2==arguments.length&&h.isStr(d)&&(b={},c=d,p[c]||(p[c]=null!==(z=c.match(P))?H[z[1]](z[2].replace(/['"]$/,"")):new Function("x,rec",
"try { return x "+c+"} catch(e) {return undefined;}")),b[a]=p[c]);return b}}};var J,K={};l("has hasKey insert invert missing isin group keyBy remove update where select find sort orderBy order each like".split(" "),function(a){K[a]=!0});J=K;self.DB=function(a,d){function b(){k||(k=!0,l(f,function(a){a.call(g,m)}),k=!1)}function c(a){for(var b in J)a[b]=g[b];return a}var e={addIf:[]},f=[],k=!1,j=!1,g=I(),m=[];q(g,{transaction:{start:function(){k=!0},end:function(){k=!1;b()}},schema:function(){for(var a=
{},b=m.length,c,e=0;e<b;e+=10,c=m[e])for(var d in c)a[d]=void 0;return O(a)},constrain:function(){var a=q,b=e,c;c=arguments;var d={};2==c.length?(d[c[0]]=c[1],c=d):c=1==c.length?c[0]:void 0;a(b,c)},addIf:function(a){a&&e.addIf.push(a);return e.addIf},each:v,findFirst:function(){var a=g.find.apply(this,n.call(arguments));return a.length?a[0]:{}},has:M,hasKey:function(){return this.find(A(n.call(arguments))).invert()},isin:x,like:B,invert:function(a){var b=m,e=[];F(a||this);a=0;for(var d=b.length;a<
d;a++)b[a].constructor("i")==s||e.push(b[a]);return c(e)},map:v,missing:function(){var a=A(n.call(arguments));return h.isArr(this)?this.find(a):a},sync:function(a){a?f.push(a):b()},template:{create:function(a){j=a},update:function(a){q(j||{},a)},get:function(){return j},destroy:function(){j=!1}},update:function(){var a=N.apply(h.isArr(this)?this:g.find(),n.call(arguments));b();return c(a)}});g.not=function(){return g.apply(this,n(arguments))};g.group=function(a){var b={},e=h.isArr(this)?this:g.find();
l(e,function(e){a in e&&(b[e[a]]||(b[e[a]]=c([])),b[e[a]].push(e))});return b};g.keyBy=function(a){var b=g.group.apply(this,arguments);l(b,function(a,c){b[a]=c[0]});return b};g.order=g.sort=g.orderBy=function(a,b){var e,d=arguments.length,f,j=h.isArr(this)?this:g.find();h.isFun(a)?e=a:h.isStr(a)&&(1==d?f="x-y":2==d&&(f=h.isStr(b)?{asc:"x-y",desc:"y-x"}[b.toLowerCase()]:b),h.isStr(f)&&!G[f]&&(G[f]=new Function("x,y","return "+f)),eval("fnSort=function(a,b){return order(a."+a+", b."+a+")}"));return c(n.call(j).sort(e))};
g.where=g.find=function(){var a=n.call(arguments||[]);h.isArr(this)||(a=[m].concat(a));return c(t.apply(this,a))};g.view=function(a){var c={};g.sync(function(b){var e={},d;l(b,function(b){a in b&&(e[b[a]]=b)});for(d in e)d in c?c[d]!==e[d]&&(c[d]=e[d]):c[d]=e[d];for(d in c)d in e||delete c[d]});b();return c};g.select=function(a){var b=h.isArr(this)?this:g.find(),e,d={};1<arguments.length?a=n.call(arguments):h.isStr(a)&&(a=[a]);e=a.length;l(a,function(a,c){if("*"==a)d=E(b,u);else for(var g=0,f=b.length;g<
f;g++)row=b[g],a in row&&(1<e?(d[g]||(d[g]=[]),d[g][c]=row[a]):d[g]=row[a])});return c(u(d))};g.insert=function(a){var d,g={},f=[],k=[],f=1<arguments.length?n.call(arguments):h.isArr(a)?a:[a];l(f,function(a){var b=!0;e.unique&&(g={},l(m,function(a,b){g[a[e.unique]]=b}),a[e.unique]in g&&(k.push(g[a[e.unique]]),b=!1));l(e.addIf,function(c){b&=c(a)});if(b){d=m.length;var c;if(j){var f={};l(j,function(a,b){f[a]=h.isFun(b)?b():b});a=q(f,a)}try{c=new (C(d)),q(c,a),m.push(c)}catch(n){a.constructor=C(d),
m.push(a)}k.push(d)}});b();for(var f=k,L=[],p=0,r=f.length;p<r;p++)L[p]=m[f[p]];return c(L)};g.remove=function(a,e){var d,f,j=[];d=h.isArr(this)?this:h.isArr(a)?a:0<arguments.length?g.find.apply(this,n.call(arguments)):g.find();F(d);var k=m.length-1;for(d=m.length;0<=k;k--)m[k].constructor("i")==s?j.push(m[k]):(d-(k+1)&&(f=k+1,m.splice(f,d-f)),d=k);f=k+1;d-f&&m.splice(f,d-f);b();return c(j.reverse())};if(1==arguments.length)if(h.isArr(a))g.insert(a);else if(h.isFun(a))g.insert(a());else{if(h.isStr(a))return g.apply(this,
arguments);h.isObj(a)&&g.insert(a)}else 1<arguments.length&&g.insert(n.call(arguments));g.__raw__=m;return g};q(DB,{find:t,each:v,like:B,trace:function(a,d){a.__$$tracer$$__={};l(a,function(b,c){h.isFun(c)&&(a.__$$tracer$$__[b]=c,a[b]=function(){console.log.apply(this,[b+":"].concat(n.call(arguments)));d&&d.apply(this,arguments);return a.__$$tracer$$__[b].apply(this,arguments)})})},isin:x,objectify:function(a,d){var b=[];l(d,function(c){var d={};l(a,function(a,b){d[a]=c[b]});b.push(d)});return b},
findFirst:function(){var a=t.apply(this,n.call(arguments));return a.length?a[0]:{}},reduceLeft:function(a,d){var b=h.isStr(d)?new Function("y,x","return y "+d):d;return function(c){for(var d=a,f=0,h=c.length;f<h;f++)c[f]&&(d=b(d,c[f]));return d}},reduceRight:function(a,d){d=DB.reduceLeft(a,d);return function(a){return d(a.reverse())}}})})();
