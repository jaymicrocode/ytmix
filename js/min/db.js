(function(){function r(a,d){for(var c,b,f,e,g=arguments.length,h=0;h<g;h++){c=arguments[h];for(var m in c)b=a[m],f=c[m],a!==f&&(f&&(f.constructor==Object||(e=k.isArr(f)))?(e?(e=!1,b=b&&k.isArr(constructor)?b:[]):b=b&&b.constructor==Object?b:{},a[m]=r(b,f)):f!==z&&(a[m]=f))}return a}function I(a){var d={};n(a,function(a){d[a]=!0});return d}function J(a){return a.length?q.call(a):v(a)}function w(a,d){var c=[];A(d);for(var b=0,f=a.length;b<f;b++)a[b].constructor("i")!=s&&c.push(a[b]);return c}function A(a){s++;
for(var d=0,c=a.length;d<c;d++)a[d].constructor("i",s)}function K(a,d){var c=arguments.length,b=1==c?a:d,f,e={};k.isArr(b)?(c=b.length,f=function(a){for(var d=0;d<c;d++)if(-1<t(a,b[d]))return!0;return!1}):f=function(a){return-1<t(a,b)};return 2==c?(e={},e[a]=f,e):f}function u(){var a=q.call(arguments),d,c,b,f,e,g,h,m=J(k.isArr(this)?this:a.shift());2==a.length&&k.isStr(a[0])&&(b={},b[a[0]]=a[1],a=[r({},b)]);for(c=0;c<a.length;c++)if(d=a[c],k.isArr(d)){var l=[],p=m;for(h=0;h<d.length;h++)l=l.concat(u(p,
d[h])),p=w(p,l);m=l}else if(k.isFun(d)){d=d.single||d;e=m.length;for(h=e-1;0<=h;h--)b=m[h],d(b)&&(e-(h+1)&&(g=h+1,m.splice(g,e-g)),e=h);g=h+1;e-g&&m.splice(g,e-g)}else n(d,function(a,c){if(k.isFun(c))for(e=m.length,h=e-1;0<=h;h--)b=m[h],a in b&&(f=b[a],k.isFun(f)&&(f=f()),c(f,b)&&(e-(h+1)&&(g=h+1,m.splice(g,e-g)),e=h));else for(e=m.length,h=e-1;0<=h;h--)b=m[h],f=b[a],k.isFun(f)&&(f=f()),a in b&&f===c&&(e-(h+1)&&(g=h+1,m.splice(g,e-g)),e=h);g=h+1;e-g&&m.splice(g,e-g)});m.first=m[0];m.last=m[m.length-
1];return m}function B(a){var d=I(a);return function(a){for(var b in d)if(b in a)return!1;return!0}}function C(a,d){var c,b=arguments.length,f,e={};1==b?f=a:2==b&&(f=d);f=f.toString().toLowerCase();c=function(a){return-1<a.toString().toLowerCase().search(f)};return 2==b?(e={},e[a]=c,e):c}function D(a){var d={x:a};return function(a,b){2==arguments.length&&(d[a]=b);return d[a]}}function L(a,d){var c,b=this;d!==z&&(c=a,a={},a[c]=d);k.isFun(a)?n(b,a):n(a,function(a,c){k.isFun(c)?n(b,function(b){if(k.isFun(b[a]))b[a](c(b));
else b[a]=c(b)}):n(b,function(b){if(k.isFun(b[a]))b[a](c);else b[a]=c})});return this}function x(a,d){var c=[],b;2==arguments.length?(b=a,a=d):b=this;if(k.isArr(b))c=E(b,a);else{var c={},f;for(f in b)k.isFun(b[f])||(c[f]=a.call(this,b[f]))}return c}var z,q=Array.prototype.slice,y=Object.prototype.toString,F={},G={},s=0,k={isFun:function(a){return!!(a&&a.constructor&&a.call&&a.apply)},isStr:function(a){return!!(""===a||a&&a.charCodeAt&&a.substr)},isNum:function(a){return"[object Number]"===y.call(a)},
isArr:[].isArray||function(a){return"[object Array]"===y.call(a)},isObj:function(a){return null==a?"object"==String(a):"[object Object]"===y.call(a)||!0}},t=[].indexOf?function(a,d){return a.indexOf(d)}:function(a,d){for(var c=a.length-1;-1!=c&&d!=a[c];c--);return c},M={}.keys||function(a){var d=[],c;for(c in a)d.push(c);return d},v=function(a){var d=[],c;for(c in a)d.push(a[c]);return d},E=[].map?function(a,d){return a.map(d)}:function(a,d){for(var c=[],b=0,f=a.length;b<f;b++)c.push(d(a[b],b));return c},
n=[].forEach?function(a,d){if(0!==a.length)if(k.isArr(a))a.forEach(d);else for(var c in a)d(c,a[c])}:function(a,d){if(0!==a.length)if(k.isArr(a))for(var c=0,b=a.length;c<b;c++)d(a[c],c);else for(c in a)d(c,a[c])};n("< <= > >= == === != !==".split(" "),function(a){G[a]=Function("rhs","return function(x){return x"+a+"rhs}")});var H=function(){var a={};return function(d,c){var b,f=arguments.length,e=1==f?d:c||[],g={};if(!k.isArr(e))throw new TypeError("isin's argument is wrong. ",e);e.length?20>e.length&&
k.isNum(e[0])?(b=e.join(","),b=a[b]?a[b]:a[b]=new Function("x","return x=="+e.join("||x=="))):b=k.isStr(e)?new Function("x","return indexOf("+e+", x) > -1"):function(a){return-1<t(e,a)}:b=k.isFun(e)?function(a){return-1<t(e(),a)}:e;return 2==f?(g={},g[d]=b,g):b}}(),N=function(){var a=/^\s*([=<>!]+)['"]*(.*)$/,d,c={};return function(){return function(b,f){var e,g;if(k.isStr(b)){g=b;if(1==arguments.length)if(c[g])e=c[g];else{try{e=new Function("x,rec","try { return x "+g+"} catch(e) {return undefined;}")}catch(h){e=
{}}try{e.single=new Function("rec","try { return "+b+"} catch(e) {return undefined;}")}catch(m){}c[g]=e}2==arguments.length&&k.isStr(f)&&(e={},g=f,c[g]||(null!==(d=g.match(a))?c[g]=G[d[1]](d[2].replace(/['"]$/,"")):c[g]=new Function("x,rec","try { return x "+g+"} catch(e) {return undefined;}")),e[b]=c[g]);return e}}}}(),O=function(a){var d={};n(a,function(a){d[a]=!0});return d}("each find group has hasKey indexBy insert invert isin keyBy like missing order orderBy remove select sort unset update where".split(" "));
self.DB=function(a,d){function c(){h||(h=!0,n(g,function(a){a.call(l,p)}),h=!1)}function b(a){for(var b in O)a[b]=l[b];return a}function f(a){for(var b=[],c=0,d=a.length;c<d;c++)b[c]=p[a[c]];return b}var e={addIf:[]},g=[],h=!1,m=!1,l=N(),p=[];r(l,{transaction:{start:function(){h=!0},end:function(){h=!1;c()}},schema:function(){for(var a={},b=p.length,c,d=0;d<b;d+=10,c=p[d])for(var e in c)a[e]=void 0;return M(a)},constrain:function(){var a=r,b=e,c;c=arguments;var d={};2==c.length?(d[c[0]]=c[1],c=d):
c=1==c.length?c[0]:void 0;a(b,c)},addIf:function(a){a&&e.addIf.push(a);return e.addIf},unset:function(a){if(k.isArr(a))return n(a,arguments.callee);var d=k.isArr(this)?this:l.find();n(d,function(b){a in b&&delete b[a]});c();return b(d)},each:x,findFirst:function(){var a=l.find.apply(this,q.call(arguments));return a.length?a[0]:{}},has:K,hasKey:function(){return this.find(B(q.call(arguments))).invert()},isin:H,like:C,invert:function(a){return b(w(p,a||this))},map:x,missing:function(){var a=B(q.call(arguments));
return k.isArr(this)?this.find(a):a},sync:function(a){a?g.push(a):c();return l},template:{create:function(a){m=a},update:function(a){r(m||{},a)},get:function(){return m},destroy:function(){m=!1}},update:function(){var a=L.apply(k.isArr(this)?this:l.find(),q.call(arguments));c();return b(a)}});l.group=function(a){var c={},d=k.isArr(this)?this:l.find();n(d,function(d){a in d&&(c[d[a]]||(c[d[a]]=b([])),c[d[a]].push(d))});return c};l.keyBy=function(a){var b=l.group.apply(this,arguments);n(b,function(a,
c){b[a]=c[0]});return b};l.indexBy=function(){var a=b;b=function(a){return a};l.__raw__=p=l.order.apply(this,arguments);b=a};l.order=l.sort=l.orderBy=function(a,c){var d,e=arguments.length,f,g=k.isArr(this)?this:l.find();k.isFun(a)?d=a:k.isStr(a)&&(1==e?f="x-y":2==e&&(f=k.isStr(c)?{asc:"x-y",desc:"y-x"}[c.toLowerCase()]:c),k.isStr(f)&&!F[f]&&(F[f]=new Function("x,y","return "+f)),eval("fnSort=function(a,b){return order(a."+a+", b."+a+")}"));return b(q.call(g).sort(d))};l.where=l.find=function(){var a=
q.call(arguments||[]);k.isArr(this)||(a=[p].concat(a));return b(u.apply(this,a))};l.view=function(a){var b={};l.sync(function(c){var d={},e;n(c,function(b){a in b&&(d[b[a]]=b)});for(e in d)e in b?b[e]!==d[e]&&(b[e]=d[e]):b[e]=d[e];for(e in b)e in d||delete b[e]});c();return b};l.lazyView=function(a){function b(){var c={};n(p,function(d){a in d&&(c[d[a]]=b[d[a]]=d)});for(var d in b)d in c||delete b[d]}b();return b};l.select=function(a){var c=k.isArr(this)?this:l.find(),d,e={};1<arguments.length?a=
q.call(arguments):k.isStr(a)&&(a=[a]);d=a.length;n(a,function(a,b){if("*"==a)e=E(c,v);else for(var f=0,k=c.length;f<k;f++)row=c[f],a in row&&(1<d?(e[f]||(e[f]=[]),e[f][b]=row[a]):e[f]=row[a])});return b(v(e))};l.insert=function(a){var d,g={},l=[],h=[],l=1<arguments.length?q.call(arguments):k.isArr(a)?a:[a];n(l,function(a){var b=!0;e.unique&&(g={},n(p,function(a,b){g[a[e.unique]]=b}),a[e.unique]in g&&(h.push(g[a[e.unique]]),b=!1));n(e.addIf,function(c){b&=c(a)});if(b){d=p.length;var c;if(m){var f=
{};n(m,function(a,b){k.isFun(b)?f[a]=b():f[a]=b});a=r(f,a)}try{c=new (D(d)),r(c,a),p.push(c)}catch(l){a.constructor=D(d),p.push(a)}h.push(d)}});c();return b(f(h))};l.remove=function(a,d){var e,f,g=[];e=k.isArr(this)?this:k.isArr(a)?a:0<arguments.length?l.find.apply(this,q.call(arguments)):l.find();A(e);var h=p.length-1;for(e=p.length;0<=h;h--)p[h].constructor("i")==s?g.push(p[h]):(e-(h+1)&&(f=h+1,p.splice(f,e-f)),e=h);f=h+1;e-f&&p.splice(f,e-f);c();return b(g.reverse())};if(1==arguments.length)if(k.isArr(a))l.insert(a);
else if(k.isFun(a))l.insert(a());else{if(k.isStr(a))return l.apply(this,arguments);k.isObj(a)&&l.insert(a)}else 1<arguments.length&&l.insert(q.call(arguments));l.__raw__=p;return l};r(DB,{find:u,diff:w,each:x,like:C,trace:function(a,d){a.__$$tracer$$__={};n(a,function(c,b){k.isFun(b)&&(a.__$$tracer$$__[c]=b,a[c]=function(){console.log([c+":"].concat(q.call(arguments)));d&&d.apply(this,arguments);return a.__$$tracer$$__[c].apply(this,arguments)})})},isin:H,objectify:function(a,d){var c=[];n(d,function(b){var d=
{};n(a,function(a,c){d[a]=b[c]});c.push(d)});return c},findFirst:function(){var a=u.apply(this,q.call(arguments));return a.length?a[0]:{}},reduceLeft:function(a,d){var c=k.isStr(d)?new Function("y,x","return y "+d):d;return function(b){for(var d=a,e=0,g=b.length;e<g;e++)b[e]&&(d=c(d,b[e]));return d}},reduceRight:function(a,d){d=DB.reduceLeft(a,d);return function(a){return d(a.reverse())}}})})();
