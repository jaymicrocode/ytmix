(function(){function E(a){var c={};m(a,function(a){c[a]=!0});return c}function F(a,c){var b=arguments.length,d=b==1?a:c,f,e={};i.isArr(d)?(b=d.length,f=function(a){for(var c=0;c<b;c++)if(p(a,d[c])>-1)return!0;return!1}):f=function(a){return p(a,d)>-1};return b==2?(e={},e[a]=f,e):f}function G(a){return a.length?a.slice():r(a)}function s(){var a=n.call(arguments),c,b,d,f,e,g,h,k=G(i.isArr(this)?this:a.shift());a.length==2&&i.isStr(a[0])&&(d={},d[a[0]]=a[1],a=[o({},d)]);for(b=0;b<a.length;b++)if(c=a[b],
i.isFun(c)){c=c.single||c;for(e=k.length,h=e-1;h>=0;h--)d=k[h],c(d)&&(e-(h+1)&&(g=h+1,k.splice(g,e-g)),e=h);g=h+1;e-g&&k.splice(g,e-g)}else m(c,function(a,b){if(i.isFun(b))for(e=k.length,h=e-1;h>=0;h--)d=k[h],a in d&&(f=d[a],b(f,d)&&(e-(h+1)&&(g=h+1,k.splice(g,e-g)),e=h));else for(e=k.length,h=e-1;h>=0;h--)d=k[h],a in d&&d[a]===b&&(e-(h+1)&&(g=h+1,k.splice(g,e-g)),e=h);g=h+1;e-g&&k.splice(g,e-g)});return k}function w(){var a=E(n.call(arguments));return function(c){for(var b in a)if(b in c)return!1;
return!0}}function x(a,c){var b,d=arguments.length,f,e={};d==1?f=a:d==2&&(f=c);f=f.toString().toLowerCase();b=function(a){return a.toString().toLowerCase().search(f)>-1};return d==2?(e={},e[a]=b,e):b}function y(a){var c={x:a};return function(a,d){arguments.length==2&&(c[a]=d);return c[a]}}function r(a){var c=[],b;for(b in a)c.push(a[b]);return c}function H(a,c){var b,d=this;c!==z&&(b=a,a={},a[b]=c);i.isFun(a)?m(d,a):m(a,function(a,b){i.isFun(b)?m(d,function(d){d[a]=b(d)}):m(d,function(d){d[a]=b})});
return this}function o(a,c){for(var b,d,f,e,g=arguments.length,h=0;h<g;h++){b=arguments[h];for(var k in b)d=a[k],f=b[k],a!==f&&(f&&(f.constructor==Object||(e=i.isArr(f)))?(e?(e=!1,d=d&&i.isArr(constructor)?d:[]):d=d&&d.constructor==Object?d:{},a[k]=o(d,f)):f!==z&&(a[k]=f))}return a}function t(a,c){var b=[],d;arguments.length==2?(d=a,a=c):d=this;if(i.isArr(d))b=A(d,a);else{var b={},f;for(f in d)i.isFun(d[f])||(b[f]=a.call(this,d[f]))}return b}function B(a){q++;for(var c=0,b=a.length;c<b;c++)a[c].constructor("i",
q)}var z,n=Array.prototype.slice,u=Object.prototype.toString,v={},C={},q=0,i={isFun:function(a){return!(!a||!a.constructor||!a.call||!a.apply)},isStr:function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)},isNum:function(a){return u.call(a)==="[object Number]"},isArr:[].isArray||function(a){return u.call(a)==="[object Array]"},isObj:function(a){return a==null?String(a)=="object":u.call(a)==="[object Object]"||!0}},p=[].indexOf?function(a,c){return a.indexOf(c)}:function(a,c){for(var b=a.length-1;b!=
-1&&c!=a[b];b--);return b},A=[].map?function(a,c){return a.map(c)}:function(a,c){for(var b=[],d=0,f=obj.length;d<f;d++)b.push(c(obj[d],d));return b},m=[].forEach?function(a,c){if(i.isArr(a))a.forEach(c);else for(var b in a)c(b,a[b])}:function(a,c){if(i.isArr(a))for(var b=0,d=a.length;b<d;b++)c(a[b],b);else for(b in a)c(b,a[b])};m("< <= > >= == === != !==".split(" "),function(a){C[a]=Function("rhs","return function(x){return x"+a+"rhs}")});var D=function(){var a={};return function(c,b){var d,f=arguments.length,
e=f==1?c:b||[],g={};e.length?e.length<20&&i.isNum(e[0])?(d=e.join(","),d=a[d]?a[d]:a[d]=new Function("x","return x=="+e.join("||x=="))):d=function(a){return p(e,a)>-1}:d=i.isFun(e)?function(a){return p(e(),a)>-1}:e;return f==2?(g={},g[c]=d,g):d}}(),I=function(){var a=/^\s*([=<>!]+)['"]*(.*)$/,c,b={};return function(){return function(d,f){var e,g;if(i.isStr(d)){g=d;if(arguments.length==1)if(b[g])e=b[g];else{try{e=new Function("x,rec","return x "+g)}catch(h){e={}}try{e.single=new Function("rec","return "+
d)}catch(k){}b[g]=e}arguments.length==2&&i.isStr(f)&&(e={},g=f,b[g]||(b[g]=(c=g.match(a))!==null?C[c[1]](c[2].replace(/['"]$/,"")):new Function("x,rec","return x "+g)),e[d]=b[g]);return e}}}}(),J=function(a){var c={};m(a,function(a){c[a]=!0});return c}("has hasKey insert invert missing isin group remove update where select find sort order each like".split(" "));self.DB=function(a,c){function b(){h||(h=!0,m(g,function(a){a.call(j,l)}),h=!1)}function d(a){for(var d in J)a[d]=j[d];return a}function f(a){for(var d=
[],b=0,c=a.length;b<c;b++)d[b]=l[a[b]];return d}var e={},g=[],h=!1,k=!1,j=I(),l=[];o(j,{constrain:function(){var a=o,d=e,b;var c=arguments,f={};c.length==2?(f[c[0]]=c[1],b=f):c.length==1&&(b=c[0]);a(d,b)},each:t,findFirst:function(){var a=j.find.apply(this,n.call(arguments));return a.length?a[0]:{}},has:F,hasKey:function(){return j.find(w.apply(this,n.call(arguments))).invert()},isin:D,like:x,invert:function(a){var b=l,c=[];B(a||this);for(var a=0,e=b.length;a<e;a++)b[a].constructor("i")!=q&&c.push(b[a]);
return d(c)},map:t,missing:function(){return j.find(w.apply(this,n.call(arguments)))},sync:function(a){g.push(a)},template:{create:function(a){k=a},update:function(a){o(k||{},a)},get:function(){return k},destroy:function(){k=!1}},update:function(){var a=H.apply(i.isArr(this)?this:j.find(),n.call(arguments));b();return d(a)}});j.group=function(a){var b={},c=i.isArr(this)?this:j.find();m(c,function(c){a in c&&(b[c[a]]||(b[c[a]]=d([])),b[c[a]].push(c))});return b};j.order=j.sort=function(a,b){var c,
e=arguments.length,f,g=i.isArr(this)?this:j.find();i.isFun(a)?c=a:i.isStr(a)&&(e==1?f="x-y":e==2&&(f=i.isStr(b)?{asc:"x-y",desc:"y-x"}[b.toLowerCase()]:b),i.isStr(f)&&(f=v[f]?v[f]:v[f]=new Function("x,y","return "+f)),c=function(b,d){return f(b[a],d[a])});return d(n.call(g).sort(c))};j.where=j.find=function(){return d(s.apply(this,arguments.length?[l].concat(n.call(arguments)):[l]))};j.view=function(a){var d={};j.sync(function(b){var c={},e;m(b,function(b){a in b&&(c[b[a]]=b)});for(e in c)e in d?
d[e]!==c[e]&&(d[e]=c[e]):d[e]=c[e];for(e in d)e in c||delete d[e]});b();return d};j.select=function(a){var b=i.isArr(this)?this:j.find(),c={};arguments.length>1?a=n.call(arguments):i.isStr(a)&&(a=[a]);m(a,function(a,d){if(a=="*")c=A(b,r);else for(var e=0,f=b.length;e<f;e++)row=b[e],a in row&&(f>1?(c[e]||(c[e]=[]),c[e][d]=row[a]):c[e]=row[a])});return d(r(c))};j.insert=function(a){var c={},g=[],h=[];arguments.length>1?g=n.call(arguments):i.isArr(a)?g=a:g.push(a);m(g,function(a){if(e.unique&&(c={},
m(l,function(a,b){c[a[e.unique]]=b}),a[e.unique]in c)){h.push(c[a[e.unique]]);return}var b=l.length,d;if(k){var f={};m(k,function(a,b){f[a]=i.isFun(b)?b():b});a=o(f,a)}try{d=new (y(b)),o(d,a),l.push(d)}catch(g){a.constructor=y(b),l.push(a)}h.push(b)});b();return d(f(h))};j.remove=function(a,c){var e,f,g=[];e=i.isArr(this)?this:i.isArr(a)?a:arguments.length>0?j.find.apply(this,n.call(arguments)):j.find();B(e);var h=l.length-1;for(e=l.length;h>=0;h--)l[h].constructor("i")==q?g.push(l[h]):(e-(h+1)&&
(f=h+1,l.splice(f,e-f)),e=h);f=h+1;e-f&&l.splice(f,e-f);b();return d(g.reverse())};if(arguments.length==1)if(i.isArr(a))j.insert(a);else if(i.isFun(a))j.insert(a());else if(i.isStr(a))return j.apply(this,arguments);else i.isObj(a)&&j.insert(a);else arguments.length>1&&j.insert(n.call(arguments));j.__raw__=l;return j};o(DB,{find:s,each:t,like:x,isin:D,findFirst:function(){var a=s.apply(this,n.call(arguments));return a.length?a[0]:{}},reduceLeft:function(a,c){var b=i.isStr(c)?new Function("y,x","return y "+
c):c;return function(c){for(var f=a,e=0,g=c.length;e<g;e++)c[e]&&(f=b(f,c[e]));return f}},reduceRight:function(a,c){c=DB.reduceLeft(a,c);return function(a){return c(a.reverse())}}})})();
