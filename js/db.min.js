(function(){function x(a){var d={};l(a,function(a){d[a]=!0});return d}function y(a,d){var c=arguments.length,b=c==1?a:d,h,e={};i.isArr(b)?(c=b.length,h=function(a){for(var e=0;e<c;e++)if(o(a,b[e])>-1)return!0;return!1}):h=function(a){return o(a,b)>-1};return c==2?(e={},e[a]=h,e):h}function z(a){return a.length?m.call(a):p(a)}function A(){var a=m.call(arguments),d,c,b,h,e,g,j,k={},f=z(i.isArr(this)?this:a.shift());a.length==2&&i.isStr(a[0])&&(b={},b[a[0]]=a[1],a=[n({},b)]);for(c=0;c<a.length;c++)if(d=
a[c],i.isFun(d)){d=d.single||d;k={};for(e=f.length,j=e-1;j>=0;j--){b=f[j];if(b in k){if(!k[b])continue}else if(!(k[b]=d(b)))continue;e-(j+1)&&(g=j+1,f.splice(g,e-g));e=j}g=j+1;e-g&&f.splice(g,e-g)}else l(d,function(a,c){if(i.isFun(c)){k={};for(e=f.length,j=e-1;j>=0;j--)b=f[j],a in b&&(h=b[a],c(h,b)&&(e-(j+1)&&(g=j+1,f.splice(g,e-g)),e=j))}else for(e=f.length,j=e-1;j>=0;j--)b=f[j],a in b&&b[a]===c&&(e-(j+1)&&(g=j+1,f.splice(g,e-g)),e=j);g=j+1;e-g&&f.splice(g,e-g)});return f}function B(){var a=x(m.call(arguments));
return function(d){for(var c in a)if(c in d)return!1;return!0}}function C(a,d){var c,b=arguments.length,h,e={};b==1?h=a:b==2&&(h=d);h=h.toString().toLowerCase();c=function(a){return a.toString().toLowerCase().search(h)>-1};return b==2?(e={},e[a]=c,e):c}function u(a){var d={x:a};return function(a,b){arguments.length==2&&(d[a]=b);return d[a]}}function q(a){var d={};l(a,function(a){d[a]=!0});return d}function p(a){var d=[],c;for(c in a)d.push(a[c]);return d}function n(a,d){for(var c,b,h,e,g=arguments.length,
j=0;j<g;j++){c=arguments[j];for(var k in c)b=a[k],h=c[k],a!==h&&(h&&(h.constructor==Object||(e=i.isArr(h)))?(e?(e=!1,b=b&&i.isArr(constructor)?b:[]):b=b&&b.constructor==Object?b:{},a[k]=n(b,h)):h!==void 0&&(a[k]=h))}return a}function D(a,d){var c=[],b;arguments.length==2?(b=a,a=d):b=this;if(i.isArr(b))c=v(b,a);else{var c={},h;for(h in b)i.isFun(b[h])||(c[h]=a.call(this,b[h]))}return c}var m=Array.prototype.slice,r=Object.prototype.toString,s={},w={},i={isFun:function(a){return!(!a||!a.constructor||
!a.call||!a.apply)},isStr:function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)},isNum:function(a){return r.call(a)==="[object Number]"},isArr:[].isArray||function(a){return r.call(a)==="[object Array]"},isObj:function(a){return a==null?String(a)=="object":r.call(a)==="[object Object]"||!0}},o=[].indexOf?function(a,d){return a.indexOf(d)}:function(a,d){for(var c=a.length-1;c!=-1&&d!=a[c];c--);return c},E={}.keys||function(a){var d=[],c;for(c in a)d.push(c);return d},v=[].map?function(a,d){return a.map(d)}:
function(a,d){for(var c=[],b=0,h=obj.length;b<h;b++)c.push(d(obj[b],b));return c},l=[].forEach?function(a,d){if(i.isArr(a))a.forEach(d);else for(var c in a)d(c,a[c])}:function(a,d){if(i.isArr(a))for(var c=0,b=a.length;c<b;c++)d(a[c],c);else for(c in a)d(c,a[c])};l("< <= > >= == === != !==".split(" "),function(a){w[a]=Function("rhs","return function(x){return x"+a+"rhs}")});var F=function(){var a={};return function(d,c){var b,h=arguments.length,e=h==1?d:c||[],g={};e.length?e.length<20&&i.isNum(e[0])?
(b=e.join(","),b=a[b]?a[b]:a[b]=new Function("x","return x=="+e.join("||x=="))):b=function(a){return o(e,a)>-1}:b=i.isFun(e)?function(a){return o(e(),a)>-1}:e;return h==2?(g={},g[d]=b,g):b}}(),G=function(){var a=/^\s*([=<>!]+)['"]*(.*)$/,d,c={};return function(){return function(b,h){var e,g;if(i.isStr(b)){g=b;if(arguments.length==1)if(c[g])e=c[g];else{try{e=new Function("x,rec","return x "+g)}catch(j){e={}}try{e.single=new Function("rec","return "+b)}catch(k){}c[g]=e}arguments.length==2&&i.isStr(h)&&
(e={},g=h,c[g]||(c[g]=(d=g.match(a))!==null?w[d[1]](d[2].replace(/['"]$/,"")):new Function("x,rec","return x "+g)),e[b]=c[g]);return e}}}}();(function(){var a={},d=(Math.random()*Math.pow(2,32)).toString(36),c=1,b;a.stain=function(a){c++;b=d+c;for(var e=0,g=a.length;e<g;e++)a[e][b]=!0;return b};a.isStained=function(a){var c=a[b];c&&delete a[b];return c};return a})();var t=function(){var a={},d=0;a.stain=function(a){d++;for(var b=0,h=a.length;b<h;b++)a[b].constructor("i",d);return d};a.isStained=function(a){return a.constructor("i")==
d};return a}();stainer=t;var H=q("has missing isin group remove update where select find order each like".split(" "));self.DB=function(a,d){function c(){for(var a=0,b=g.length;a<b;a++)g[a].call(f,k)}function b(a){for(var b in H)a[b]=f[b];return a}function h(a){for(var b=[],c=0,e=a.length;c<e;c++)b[c]=k[a[c]];return b}var e={},g=[],j=!1,k=[],f=G();f.isin=F;f.has=y;f.like=C;f.each=f.map=D;f.template={create:function(a){j=a},update:function(a){n(j||{},a)},get:function(){return j},destroy:function(){j=
!1}};f.group=function(a){var c={},e=i.isArr(this)?this:f.find();l(e,function(b){c[b[a]]||(c[b[a]]=[]);c[b[a]].push(b)});return b(c)};f.sync=function(a){g.push(a)};f.order=f.sort=function(a,b){var c,e=arguments.length,d,g=i.isArr(this)?this:f.find();i.isFun(a)?c=a:i.isStr(a)&&(e==1?d="x-y":e==2&&(i.isStr(b)&&(b.toLowerCase()=="asc"?d="x-y":b.toLowerCase()=="desc"&&(d="y-x")),typeof d=="undefined"&&(d=b)),i.isStr(d)&&(d=s[d]?s[d]:s[d]=new Function("x,y","return "+d)),c=function(b,c){return d(b[a],c[a])});
return g.sort(c)};f.constrain=function(){var a=n,b=e,c;var d=arguments,f={};d.length==2?(f[d[0]]=d[1],c=f):d.length==1&&(c=d[0]);e=a(b,c)};f.inverse=function(a){arguments.length==0&&i.isArr(this)&&(a=this);var c;c=k;var d=a;c=q(c);var d=q(d),e;for(e in d)c[e]&&delete c[e];c=E(c);return b(c)};f.where=f.find=function(){return b(A.apply(this,arguments.length?[k].concat(m.call(arguments)):[k]))};f.missing=function(){return f.find(B.apply(this,m.call(arguments)))};f.findFirst=function(){var a=f.find.apply(this,
m.call(arguments));return a.length?a[0]:{}};f.select=function(a){var c=i.isArr(this)?this:f.find(),d={};arguments.length>1?a=m.call(arguments):i.isStr(a)&&(a=[a]);l(a,function(a,b){if(a=="*")d=v(c,p);else for(var e=0,f=c.length;e<f;e++)row=c[e],a in row&&(f>1?(d[e]||(d[e]=[]),d[e][b]=row[a]):d[e]=row[a])});return b(p(d))};f.insert=function(a){var d={},f=[],g=[];arguments.length>1?f=m.call(arguments):i.isArr(a)?f=a:f.push(a);e.unique&&l(k,function(a,b){d[a[e.unique]]=b});l(f,function(a){if(e.unique&&
a[e.unique]in d)g.push(d[a[e.unique]]);else{var b=k.length,c;if(j){var f={};l(j,function(a,b){f[a]=i.isFun(b)?b():b});a=n(f,a)}try{c=new (u(b)),n(c,a),k.push(c)}catch(h){if(!unsafe)a.constructor=u(b);k.push(a)}g.push(b)}});c();return b(h(g))};f.update=function(a,d){var e=i.isArr(this)?this:f.find(),g;arguments.length==2&&i.isStr(a)&&(g=a,a={},a[g]=d);i.isFun(a)?e.length&&l(e,a):l(a,function(a,b){i.isFun(b)?l(e,function(c){c[a]=b(c)}):l(e,function(c){c[a]=b})});c();return b(e)};f.remove=function(a){var d,
e,g=[];d=i.isArr(this)?this:i.isArr(a)?a:arguments.length>0?f.find(a):f.find();t.stain(d);d=k.length;for(var h=k.length-1;h>=0;h--)t.isStained(k[h])?g.push(k[h]):(d-(h+1)&&(e=h+1,k.splice(e,d-e)),d=h);e=h+1;d-e&&k.splice(e,d-e);c();return b(g)};if(arguments.length==1)if(i.isArr(a))f.insert(a);else if(i.isFun(a))f.insert(a());else if(i.isStr(a))return f.apply(this,arguments);else i.isObj(a)&&f.insert(a);else arguments.length>1&&f.insert(m.call(arguments));f.__raw__=k;return f}})();
